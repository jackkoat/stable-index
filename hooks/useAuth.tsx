// =====================================================
// Authentication Hook
// =====================================================
// Provides authentication state dan functions\n// untuk Stable Index Platform\n// =====================================================\n\nimport { useState, useEffect, createContext, useContext } from 'react';\nimport { supabase, getCurrentUser, signOut } from '../lib/supabase';\nimport { User } from '@supabase/supabase-js';\n\n// Auth interface\ninterface AuthUser {\n  id: string;\n  email?: string;\n  user_metadata?: {\n    user_name?: string;\n    country_code?: string;\n    country_name?: string;\n    organization?: string;\n    role?: string;\n  };\n}\n\ninterface UserProfile {\n  id: string;\n  user_id: string;\n  user_name: string;\n  country_code: string;\n  country_name: string;\n  organization?: string;\n  role?: string;\n  created_at: string;\n  updated_at: string;\n}\n\ninterface AuthContextType {\n  user: AuthUser | null;\n  profile: UserProfile | null;\n  loading: boolean;\n  signOut: () => Promise<void>;\n  refreshProfile: () => Promise<void>;\n}\n\n// Create Auth Context\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\n// Auth Provider Component\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [user, setUser] = useState<AuthUser | null>(null);\n  const [profile, setProfile] = useState<UserProfile | null>(null);\n  const [loading, setLoading] = useState(true);\n\n  // Load user on mount (one-time check)\n  useEffect(() => {\n    async function loadUser() {\n      setLoading(true);\n      try {\n        const currentUser = await getCurrentUser();\n        if (currentUser) {\n          setUser({\n            id: currentUser.id,\n            email: currentUser.email,\n            user_metadata: currentUser.user_metadata || {}\n          });\n          \n          // Load user profile\n          const { data: profileData } = await supabase\n            .from('profiles')\n            .select('*')\n            .eq('user_id', currentUser.id)\n            .maybeSingle();\n          \n          if (profileData) {\n            setProfile(profileData);\n          }\n        }\n      } catch (error) {\n        console.error('Error loading user:', error);\n      } finally {\n        setLoading(false);\n      }\n    }\n    loadUser();\n\n    // Set up auth listener - KEEP SIMPLE, avoid any async operations in callback\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\n      async (_event, session) => {\n        // NEVER use any async operations in callback\n        if (session?.user) {\n          setUser({\n            id: session.user.id,\n            email: session.user.email,\n            user_metadata: session.user.user_metadata || {}\n          });\n        } else {\n          setUser(null);\n          setProfile(null);\n        }\n      }\n    );\n\n    return () => subscription.unsubscribe();\n  }, []);\n\n  // Refresh user profile\n  const refreshProfile = async () => {\n    if (!user) return;\n    \n    try {\n      const { data: profileData } = await supabase\n        .from('profiles')\n        .select('*')\n        .eq('user_id', user.id)\n        .maybeSingle();\n      \n      if (profileData) {\n        setProfile(profileData);\n      }\n    } catch (error) {\n      console.error('Error refreshing profile:', error);\n    }\n  };\n\n  // Sign out function\n  const handleSignOut = async () => {\n    try {\n      await signOut();\n      setUser(null);\n      setProfile(null);\n    } catch (error) {\n      console.error('Error signing out:', error);\n      throw error;\n    }\n  };\n\n  const value = {\n    user,\n    profile,\n    loading,\n    signOut: handleSignOut,\n    refreshProfile\n  };\n\n  return (\n    <AuthContext.Provider value={value}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\n// Custom hook to use auth context\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}\n\n// Auth guard component\nexport function AuthGuard({ children }: { children: React.ReactNode }) {\n  const { user, loading } = useAuth();\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-surface-primary flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-16 h-16 border-4 border-accent-navy border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-text-secondary\">Loading authentication...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return null; // User will be redirected to login\n  }\n\n  return <>{children}</>;\n}\n\n// Export types for use in components\nexport type { AuthUser, UserProfile };